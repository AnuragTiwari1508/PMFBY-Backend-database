const winston = require('winston');\nconst path = require('path');\n\n// Define log levels\nconst logLevels = {\n  error: 0,\n  warn: 1,\n  info: 2,\n  http: 3,\n  debug: 4\n};\n\n// Define log colors\nconst logColors = {\n  error: 'red',\n  warn: 'yellow',\n  info: 'green',\n  http: 'magenta',\n  debug: 'blue'\n};\n\n// Add colors to winston\nwinston.addColors(logColors);\n\n// Create logs directory if it doesn't exist\nconst fs = require('fs');\nconst logsDir = path.join(process.cwd(), 'logs');\nif (!fs.existsSync(logsDir)) {\n  fs.mkdirSync(logsDir, { recursive: true });\n}\n\n// Define log format\nconst logFormat = winston.format.combine(\n  winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),\n  winston.format.errors({ stack: true }),\n  winston.format.json(),\n  winston.format.prettyPrint()\n);\n\n// Define console format (for development)\nconst consoleFormat = winston.format.combine(\n  winston.format.colorize({ all: true }),\n  winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),\n  winston.format.printf(({ timestamp, level, message, ...meta }) => {\n    const metaString = Object.keys(meta).length ? JSON.stringify(meta, null, 2) : '';\n    return `${timestamp} [${level}]: ${message} ${metaString}`;\n  })\n);\n\n// Create transports array\nconst transports = [\n  // Console transport (always active)\n  new winston.transports.Console({\n    format: consoleFormat,\n    level: process.env.NODE_ENV === 'development' ? 'debug' : 'info'\n  }),\n  \n  // File transport for all logs\n  new winston.transports.File({\n    filename: path.join(logsDir, 'app.log'),\n    format: logFormat,\n    level: 'info',\n    maxsize: 5242880, // 5MB\n    maxFiles: 5\n  }),\n  \n  // File transport for errors only\n  new winston.transports.File({\n    filename: path.join(logsDir, 'error.log'),\n    format: logFormat,\n    level: 'error',\n    maxsize: 5242880, // 5MB\n    maxFiles: 5\n  }),\n  \n  // File transport for HTTP requests\n  new winston.transports.File({\n    filename: path.join(logsDir, 'http.log'),\n    format: logFormat,\n    level: 'http',\n    maxsize: 10485760, // 10MB\n    maxFiles: 3\n  })\n];\n\n// Create logger instance\nconst logger = winston.createLogger({\n  levels: logLevels,\n  level: process.env.LOG_LEVEL || 'info',\n  format: logFormat,\n  transports,\n  \n  // Handle exceptions and rejections\n  exceptionHandlers: [\n    new winston.transports.File({\n      filename: path.join(logsDir, 'exceptions.log'),\n      format: logFormat\n    })\n  ],\n  \n  rejectionHandlers: [\n    new winston.transports.File({\n      filename: path.join(logsDir, 'rejections.log'),\n      format: logFormat\n    })\n  ],\n  \n  exitOnError: false\n});\n\n// Add custom methods for specific use cases\nlogger.logAPIRequest = (req, res, responseTime) => {\n  const logData = {\n    method: req.method,\n    url: req.originalUrl,\n    statusCode: res.statusCode,\n    responseTime: `${responseTime}ms`,\n    userAgent: req.get('User-Agent'),\n    ip: req.ip || req.connection.remoteAddress,\n    userId: req.user?.id || 'anonymous'\n  };\n  \n  if (res.statusCode >= 400) {\n    logger.error('API Request Failed', logData);\n  } else {\n    logger.http('API Request', logData);\n  }\n};\n\nlogger.logUserActivity = (userId, action, details = {}) => {\n  logger.info('User Activity', {\n    userId,\n    action,\n    details,\n    timestamp: new Date().toISOString()\n  });\n};\n\nlogger.logSecurityEvent = (event, details = {}) => {\n  logger.warn('Security Event', {\n    event,\n    details,\n    timestamp: new Date().toISOString()\n  });\n};\n\nlogger.logDatabaseOperation = (operation, collection, details = {}) => {\n  logger.debug('Database Operation', {\n    operation,\n    collection,\n    details,\n    timestamp: new Date().toISOString()\n  });\n};\n\nlogger.logMLOperation = (operation, modelName, details = {}) => {\n  logger.info('ML Operation', {\n    operation,\n    modelName,\n    details,\n    timestamp: new Date().toISOString()\n  });\n};\n\nlogger.logPerformance = (operation, duration, details = {}) => {\n  logger.info('Performance Metric', {\n    operation,\n    duration: `${duration}ms`,\n    details,\n    timestamp: new Date().toISOString()\n  });\n};\n\n// Stream for Morgan HTTP logging\nlogger.stream = {\n  write: (message) => {\n    logger.http(message.trim());\n  }\n};\n\nmodule.exports = logger;