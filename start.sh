#!/bin/bash\n\n# PMFBY Backend Complete Setup ‡§î‡§∞ Startup Script\n# ‡§Ø‡§π script ‡§∏‡§≠‡•Ä components ‡§ï‡•ã ‡§è‡§ï ‡§∏‡§æ‡§• setup ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡•à\n\necho \"üöÄ Starting PMFBY Backend Complete Setup...\"\necho \"=====================================\\n\"\n\n# Colors for output\nRED='\\033[0;31m'\nGREEN='\\033[0;32m'\nYELLOW='\\033[1;33m'\nBLUE='\\033[0;34m'\nNC='\\033[0m' # No Color\n\n# Function to print colored output\nprint_status() {\n    echo -e \"${GREEN}[INFO]${NC} $1\"\n}\n\nprint_warning() {\n    echo -e \"${YELLOW}[WARNING]${NC} $1\"\n}\n\nprint_error() {\n    echo -e \"${RED}[ERROR]${NC} $1\"\n}\n\nprint_step() {\n    echo -e \"\\n${BLUE}[STEP]${NC} $1\"\n    echo \"----------------------------------------\"\n}\n\n# Check if required tools are installed\ncheck_requirements() {\n    print_step \"Checking system requirements...\"\n    \n    # Check Node.js\n    if command -v node &> /dev/null; then\n        NODE_VERSION=$(node --version)\n        print_status \"Node.js version: $NODE_VERSION\"\n    else\n        print_error \"Node.js is not installed. Please install Node.js 16+ from https://nodejs.org/\"\n        exit 1\n    fi\n    \n    # Check npm\n    if command -v npm &> /dev/null; then\n        NPM_VERSION=$(npm --version)\n        print_status \"npm version: $NPM_VERSION\"\n    else\n        print_error \"npm is not installed.\"\n        exit 1\n    fi\n    \n    # Check Python\n    if command -v python3 &> /dev/null; then\n        PYTHON_VERSION=$(python3 --version)\n        print_status \"Python version: $PYTHON_VERSION\"\n    else\n        print_error \"Python 3 is not installed. Please install Python 3.8+ from https://python.org/\"\n        exit 1\n    fi\n    \n    # Check Flutter\n    if command -v flutter &> /dev/null; then\n        FLUTTER_VERSION=$(flutter --version | head -n 1)\n        print_status \"Flutter version: $FLUTTER_VERSION\"\n    else\n        print_warning \"Flutter is not installed. Install from https://flutter.dev/\"\n    fi\n    \n    print_status \"All system requirements met! ‚úÖ\"\n}\n\n# Setup backend dependencies\nsetup_backend() {\n    print_step \"Setting up Backend Server (Node.js)...\"\n    \n    cd backend/\n    \n    if [ ! -f \"package.json\" ]; then\n        print_error \"package.json not found in backend directory!\"\n        exit 1\n    fi\n    \n    print_status \"Installing Node.js dependencies...\"\n    npm install\n    \n    # Create logs directory if it doesn't exist\n    if [ ! -d \"logs\" ]; then\n        mkdir logs\n        print_status \"Created logs directory\"\n    fi\n    \n    print_status \"Backend setup completed! ‚úÖ\"\n    cd ..\n}\n\n# Setup Python ML server\nsetup_ml_server() {\n    print_step \"Setting up ML Server (Python)...\"\n    \n    cd backend/ml_server/\n    \n    if [ ! -f \"requirements.txt\" ]; then\n        print_error \"requirements.txt not found in ml_server directory!\"\n        exit 1\n    fi\n    \n    # Create virtual environment\n    if [ ! -d \"venv\" ]; then\n        print_status \"Creating Python virtual environment...\"\n        python3 -m venv venv\n    fi\n    \n    # Activate virtual environment\n    source venv/bin/activate\n    \n    print_status \"Installing Python dependencies...\"\n    pip install -r requirements.txt\n    \n    # Create models directory\n    if [ ! -d \"models\" ]; then\n        mkdir models\n        print_status \"Created models directory\"\n    fi\n    \n    print_status \"ML Server setup completed! ‚úÖ\"\n    deactivate\n    cd ../..\n}\n\n# Setup Flutter app\nsetup_flutter() {\n    print_step \"Setting up Flutter App...\"\n    \n    if [ ! -f \"pubspec.yaml\" ]; then\n        print_warning \"pubspec.yaml not found. Skipping Flutter setup.\"\n        return\n    fi\n    \n    print_status \"Getting Flutter dependencies...\"\n    flutter pub get\n    \n    print_status \"Generating code for models and API service...\"\n    flutter packages pub run build_runner build\n    \n    print_status \"Flutter setup completed! ‚úÖ\"\n}\n\n# Check environment file\ncheck_env_file() {\n    print_step \"Checking environment configuration...\"\n    \n    if [ ! -f \".env\" ]; then\n        if [ -f \".env.example\" ]; then\n            print_warning \".env file not found. Copying from .env.example...\"\n            cp .env.example .env\n            print_warning \"Please edit .env file with your actual configuration before starting servers!\"\n        else\n            print_error \".env file not found and no .env.example available!\"\n            exit 1\n        fi\n    else\n        print_status \"Environment file found ‚úÖ\"\n    fi\n}\n\n# Start all servers\nstart_servers() {\n    print_step \"Starting all servers...\"\n    \n    # Start ML server in background\n    print_status \"Starting ML Server on port 5000...\"\n    cd backend/ml_server/\n    source venv/bin/activate\n    python app.py &\n    ML_PID=$!\n    deactivate\n    cd ../..\n    \n    sleep 3\n    \n    # Start backend server in background\n    print_status \"Starting Backend Server on port 3000...\"\n    cd backend/\n    npm run dev &\n    BACKEND_PID=$!\n    cd ..\n    \n    sleep 3\n    \n    print_status \"All servers started! üöÄ\"\n    print_status \"Backend Server: http://localhost:3000\"\n    print_status \"ML Server: http://localhost:5000\"\n    print_status \"Backend PID: $BACKEND_PID\"\n    print_status \"ML Server PID: $ML_PID\"\n    \n    echo -e \"\\n${GREEN}Setup completed successfully! üéâ${NC}\"\n    echo -e \"\\n${YELLOW}To test the setup:${NC}\"\n    echo \"1. Check backend health: curl http://localhost:3000/health\"\n    echo \"2. Check ML server health: curl http://localhost:5000/health\"\n    echo \"3. Run Flutter app: flutter run\"\n    echo -e \"\\n${YELLOW}To stop servers:${NC}\"\n    echo \"kill $BACKEND_PID $ML_PID\"\n    \n    # Save PIDs for later use\n    echo \"$BACKEND_PID $ML_PID\" > .server_pids\n}\n\n# Stop servers function\nstop_servers() {\n    print_step \"Stopping all servers...\"\n    \n    if [ -f \".server_pids\" ]; then\n        PIDS=$(cat .server_pids)\n        kill $PIDS 2>/dev/null\n        rm .server_pids\n        print_status \"Servers stopped ‚úÖ\"\n    else\n        print_warning \"No running servers found\"\n    fi\n}\n\n# Test setup function\ntest_setup() {\n    print_step \"Testing setup...\"\n    \n    # Test backend server\n    if curl -s http://localhost:3000/health > /dev/null; then\n        print_status \"Backend server is running ‚úÖ\"\n    else\n        print_error \"Backend server is not responding ‚ùå\"\n    fi\n    \n    # Test ML server\n    if curl -s http://localhost:5000/health > /dev/null; then\n        print_status \"ML server is running ‚úÖ\"\n    else\n        print_error \"ML server is not responding ‚ùå\"\n    fi\n}\n\n# Main script logic\ncase \"$1\" in\n    \"setup\")\n        check_requirements\n        check_env_file\n        setup_backend\n        setup_ml_server\n        setup_flutter\n        echo -e \"\\n${GREEN}Complete setup finished! Now run: ./start.sh start${NC}\"\n        ;;\n    \"start\")\n        start_servers\n        ;;\n    \"stop\")\n        stop_servers\n        ;;\n    \"test\")\n        test_setup\n        ;;\n    \"restart\")\n        stop_servers\n        sleep 2\n        start_servers\n        ;;\n    *)\n        echo \"PMFBY Backend Management Script\"\n        echo \"===============================\\n\"\n        echo \"Usage: $0 {setup|start|stop|test|restart}\"\n        echo \"\"\n        echo \"Commands:\"\n        echo \"  setup    - Complete project setup (first time only)\"\n        echo \"  start    - Start all servers (backend + ML)\"\n        echo \"  stop     - Stop all running servers\"\n        echo \"  test     - Test if servers are running\"\n        echo \"  restart  - Stop and start all servers\"\n        echo \"\"\n        echo \"Examples:\"\n        echo \"  $0 setup     # First time setup\"\n        echo \"  $0 start     # Start development servers\"\n        echo \"  $0 stop      # Stop all servers\"\n        echo \"  $0 test      # Check server status\"\n        exit 1\n        ;;\nesac"